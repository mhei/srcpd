Autor: Matthias Trute, mailto:mtrute@web.de
Datum: Sommer 2001
Version: 1 \beta ($Id$)
Lizenz: GPL v2 für das gesamte Packet

Zweck des Programms: 
    SRCP Kommandos werden über das Netzwerk
    entgegengenommen und mit einem am Server
    angeschlossenen Märklin Interface 6051
    an die Modellbahn übermittelt und die
    Rückmeldemodule eingelesen.

    6050 und die Intellibox funktionieren auch.

    Für die Intellibox ist von Frank Schmischke
    das Programm intelliboxd entstanden. Es basiert
    auf einer früheren Fassung des m6051d, reizt dafür
    die IB aber aus.
    
SRCP?
    Simple Railroad Command Protocol
    eine Entwicklung aus dem usenet
    (news:de.rec.modelle.bahn) um Modellbahnen
    mit dem Computer zu steuern. Die Betonung
    liegt auf dem S ;=)
    Aktuell ist Version 0.7.3


SRCP Parameter:
    Für GL gilt das Protokoll PS, es werden aber alle Protokolle
     außer SM wohlwollend akzeptiert (n_fkt sollte aber 4 sein, anderes 
     ist noch nicht allzu ausführlich getestet).
    Für GA wird das Protokoll (M, N) ignoriert, die minimale
     Einschaltzeit wird auf 75 msec gesetzt, egal was im Befehl steht.
    FB's sind vom Typ M6051 und brauchen nicht initialisiert zu werden,
     das erfolgt hardcoded im Quelltext.
    INFO Ausgaben spiegeln den zuletzt erfolgreich an die Anlage übermittelten 
     Status wider.


Installation und Benutzen:
    das Interface 6051 entsprechend den Hinweisen von Märklin 
    an /dev/ttyS0 und einem S88 Modul anschließen.
    Steckt das Interface nicht an diesem Port oder 
    fehlt das S88, ist der Quelltext entsprechend 
    anzupassen.

    Der Quelltext ist auch Quell für alles noch nicht
    erledigte sowie kleinere und größere Ungenauigkeiten
    bei der Interpretation des SRCP, die allerdings aus
    einer gewissen Großzügigkeit entspringen soll(t)en.
    
    Probleme können eigentlich nur beim 6051 und
    bei den pthread's auftreten. Die libpthread muß
    installiert sein (SuSE 7.0 benutzt der Autor).
    dann einfach starten (normale Benutzerrechte reichen aus, es gibt
    keine Kommandozeilenparameter) und laufen lassen,
    die Steuerprogramme aufrufen und mit dem Server
    verbinden: tcp Port's 12345/12346/12347, telnet reicht ;=)

    Der 6051 ist mitunter recht widerspenstig, der Thread
    muß mitunter laufend neu gestartet werden. Da hilft wohl
    nur ein sehr kurzes serielles Kabel zwischen Interface und
    Rechner (meines ist wohl 6-7m lang). Das regelt aber der
    interne Wachhund ganz gut, Im Zweifel den info-Port beobachten,
    was dort herauskommt hat das Interface auch erreicht.
    
    Weiter schreibt der Dämon alles auch ins syslog des
    Systems (INFO), je nach Konfiguration steht dann
    in /var/log/messages ein hilfreicher Hinweis (insb.
    Oopse des M6051D sind zu beachten). Dabei steht auch
    immer eine Zahl, die gibt den Abbruchort an. Diese
    Zahl zusammen mit dem Welcome-String an mich senden,
    falls es meiner Hilfe bedarf.
    
    Beendet wird der Server durch den Befehl shutdown auf
    dem Kommandoport (siehe SRCP Spezifikation)

Programmstruktur
    Das Programm wird beim Start ein Dämon und startet
    für jeden Netzwerkport einen eigenen Thread. Daneben
    wird für jedes angeschlossene Gerät (6051, I8255, S88)
    ein eigener Thread gestartet. D.h. im Grundzustand
    laufen 1 master, 1 pthread-interner, 3 für die Netzwerk-
    Ports, je einer für das 6051, 8255 und S88 und einer
    für das TIME Feature. Macht 9 Threads. In diesem Zustand
    werden bereits alle FB Module ausgelesen, sofern initialisiert.
     
    Jede aktive Verbindung wird daneben wiederum von jeweils
    einem eigenen Thread bedient.
    
Bekannte Unzulänglichkeiten
    C-Kenntnisse des Autors? keine!!
    Alle Parameter sind hardcoded, Ports und Gerät können via
      Kommandozeile verändert werden.
    Das Timing der Datenübermittlung ist kritisch und "handverlesen"
    Andere Protokolle außer dem M2 (6090x) sind nicht vollständig getestet,
     die Absicherungen sind eher unterentwickelt.
    Die Totzeit bis zum Wirksamwerden eines Befehls kann schon mal länger dauern..
     vor allem, wenn viele Befehle für ein Gerät anstehen.
    Beim Hängenbleiben der 6051-Kommunikation wird dieser nach 2 Sekunden neu 
     gestartet, dabei wird der aktuelle Befehl zwar verworfen, aber danach
     fast immer neu gesendet. Das "fast" ist aber wirklich Pech. 

Ausrüstung beim Autor:
    6021 mit 6051, daran ein Vissmann 5217 (S88 komp.)
    8 Weichenantriebe, 3 Entkupplungsgleise über k83
    4 Loks mit Digitaldekoder (delta, 6090x)
    
    Pentium 133/32MB mit X11, SuSE Linux 6.2

Verwandte Programme:
    siehe http://www.der-moba.de/Digital

Rechtliches: Für die vorliegende Software
    wird keine Haftung übernommen. Aus der
    Tatsache, das es beim Autor zu seiner Zufriedenheit 
    funktioniert kann niemals geschlußfolgert werden, 
    das es auch bei anderen funktioniert und keinen 
    Schaden anrichtet. Wer dieses Programm
    benutzt, tut es auf eigene Gefahr. Beim Autor
    gab es schon Hardwareschäden!
    
Sonst noch was?
    Jede Änderung und jeder Erfahrungsbericht
    ist a) willkommen und b) sollte irgendwie
    auch beim Autor ankommen. Hilfreich ist dann
    Angaben zur Version (steht im Welcome des
    laufenden Servers).

Änderungen gegenüber früher
    11.4.2000: Timing bei der Kommunikation mit dem 6051 sowie
               Logik bei der Ansteuerung der Fahrrichtungswechsel.

    16.4.2000: FB sendet beim Login alle belegten Besetztmelder, 
               S88 ist ein Alias zum M6051 (gehen jetzt die 
               Kompatabilitätsprobleme los??). Der tcl/tk Client
	       Lok16 hat Anschluß am Info-Port.
	       
    29.4.2000: Neuer Standard, neues Glück, 6051er Kommunikation
	       optimiert.
	       
    3.5.2000:  ein wahrer Dämon läuft nun mal im Hintergrund und 
               schreibt in den syslog.

    21.5.2000: Beim Starten wird der Strom erst mal abgeschaltet.
               Das M6051 liefert da nichts, also muß es gesetzt werden,
               damit Server und Anlage einer Meinung sind.
	       
    18.6.2000: SRCP 0.7 brachte Veränderungen bei der Programmierung
               der Dekoder (wird aber erst mal nicht unterstützt) und
               mehr Fahrstufen bei den "besseren" Märklin-Lokdekodern.
               (das wird noch nicht umgesetzt).
	       
    3.1.2001:  Datei aufgeteilt und experimentellen 8255 Code hinzugefügt.

Last But Not Least:
    Dank geht an die Truppe von www.der_moba.de.
    
Weitere Informationen: 
    http://www.der-moba.de/Digital
    
