Autor: Matthias Trute, mailto:mtrute@web.de
Datum: Sommer 2001
Version: 1 \beta ($Id$)
Lizenz: GPL v2 für das gesamte Packet

Zweck des Programms: 
    SRCP Kommandos werden über das Netzwerk entgegengenommen und mit
    einem am Server angeschlossenen Interface (zur Zeit Märklin
    Interface 6050/6051 und Intellibox) an die Modellbahn übermittelt
    und die Rückmeldemodule eingelesen.


SRCP?
    Simple Railroad Command Protocol
    eine Entwicklung aus dem usenet
    (news:de.rec.modelle.bahn) um Modellbahnen
    mit dem Computer zu steuern. Die Betonung
    liegt auf dem S ;=)
    Aktuell ist Version 0.7.3


SRCP Parameter (für die Insider, alle anderen bitte ignorieren):
    Für GL gilt das Protokoll PS, es werden aber alle Protokolle
     außer SM wohlwollend akzeptiert (n_fkt sollte aber 4 sein, anderes 
     ist noch nicht allzu ausführlich getestet).
    Für GA wird das Protokoll (M, N) ignoriert, die minimale
     Einschaltzeit wird auf 75 msec gesetzt, egal was im Befehl steht.
    FB's sind vom Typ S88 und brauchen nicht initialisiert zu werden,
     das erfolgt hardcoded im Quelltext.
    INFO Ausgaben spiegeln den zuletzt erfolgreich an die Anlage übermittelten 
     Status wider.


Installieren und Benutzen:
    das Interface ist entsprechend den Hinweisen des jeweiligen
    Herstellers an /dev/ttySx anzuschließen und mit der Modellbahnanlage
    zu verbinden.
    In der Datei /usr/local/etc/srcpd.conf können verschiedene
    Parameter gesetzt werden.

    Der Quelltext ist auch Quell für alles noch nicht
    erledigte sowie kleinere und größere Ungenauigkeiten
    bei der Interpretation des SRCP, die allerdings aus
    einer gewissen Großzügigkeit entspringen soll(t)en.
    
    Probleme können eigentlich nur beim 6051 und
    bei den pthread's auftreten. Die libpthread muß
    installiert sein 
    
    Beim Selbstbau der glibc darf glibc-linuxthreads-... nicht
    vergessen werden.
    
    Mit srcpd -h erhält man eine Übersicht über die möglichen
    Parameter (sollte aber wegen der srcpd.conf nicht nötig sein).
    Wenn das Packet mit --enable-testmode konfiguriert wurde, kann
    mit der Option -t der Testmodus eingeschaltet werden. Der Server
    verhält sich ganz normal, jedoch findet keine Überprüfung des
    angeschlossenen Interfaces statt, und es wird nicht wirklich auf
    das Interface zugegriffen.

    Dann einfach starten (für die IB muß dies als root wegen 
    verschiedener Portzugriffe geschehen, beim 6051 ist dies nicht
    erforderlich) und laufen lassen.
    Dann die Steuerprogramme aufrufen und mit dem Server
    verbinden: tcp Port's 12345/12346/12347, telnet reicht ;=)

    Das 6051 ist mitunter recht widerspenstig, der Thread
    muß mitunter neu gestartet werden. Da hilft wohl
    nur ein kurzes serielles Kabel zwischen Interface und
    Rechner (meines ist wohl 6-7m lang). Das regelt aber der
    interne Wachhund ganz gut, Im Zweifel den info-Port beobachten,
    was dort herauskommt hat das Interface auch erreicht.
    
    Weiter schreibt der Dämon alles auch ins syslog des
    Systems (INFO), je nach Konfiguration steht dann
    in /var/log/messages ein hilfreicher Hinweis (insb.
    Oopse des SRCPD sind zu beachten). Dabei steht auch
    fast immer eine Zahl, die gibt den Abbruchort an. Diese
    Zahl zusammen mit dem Welcome-String an Matthias Trute senden,
    falls es einer Hilfe bedarf.
    
    Beendet wird der Server durch den Befehl shutdown auf
    dem Kommandoport (siehe SRCP Spezifikation)

Programmstruktur
    Das Programm liest zuerst eine eventuell vorhandene
    Konfigurationsdatei und wertet anschließend die Parameter der
    Kommandozeile aus. Wenn dann die Initialisierung des
    Interfaces erfolgreich verlaufen ist, wird das Programm ein
    Dämon und startet für jeden Netzwerkport einen eigenen Thread.
    Daneben wird für jedes angeschlossene Gerät (interface, I8255, S88)
    ein eigener Thread gestartet. D.h. im Grundzustand
    laufen 1 master, 1 pthread-interner, 3 für die Netzwerk-
    Ports, je einer für das Interface, 8255 und S88 und einer
    für das TIME Feature. Macht 9 Threads. Aber keine Angst: wir
    haben den Überblick
    
    In diesem Zustand werden bereits alle FB Module ausgelesen, 
    sofern initialisiert.
     
    Jede aktive Verbindung wird daneben wiederum von jeweils
    einem eigenen Thread bedient. Bricht eine Verbindung ab,
    ohne das ein LOGOUT stattfand, erkennt dies der Server
    irgendwann von selbst. In einigen Fällen aber auch nicht.
    Hinweise oder gar Bugfixes werden gerne angenommen.
    
Bekannte Unzulänglichkeiten
    Das Timing der Datenübermittlung ist kritisch und "handverlesen"

    Andere Protokolle außer dem M2 (6090x) sind beim M605X nicht
    vollständig getestet, die Absicherungen sind eher unterentwickelt.

    Die Totzeit bis zum Wirksamwerden eines Befehls kann schon mal
    länger dauern, vor allem wenn viele Befehle für ein Gerät anstehen.
    Dies liegt aber auch am 6021, das einige Befehle vom 6051 erst beim
    normalen Refresh einarbeitet, und das kann einige Sekunden dauern...

    Beim Hängenbleiben der 6051-Kommunikation wird dieser nach 2 Sekunden neu
    gestartet, dabei wird der aktuelle Befehl zwar verworfen, aber danach
    fast immer neu gesendet. Das "fast" ist aber wirklich Pech.

Ausrüstung beim Autor (Matthias Trute):
    6021 mit 6051, daran ein Vissmann 5217 (S88 komp.)
    8 Weichenantriebe, 3 Entkupplungsgleise über k83
    4 Loks mit Digitaldekoder (delta, 6090x)
    
    2Pentium's, zusammen 366MHz und 10MBit dazwischen.
    jeweils SuSE 7.1, 2.4.0 (Server) und 2.2.18 (Client)

Ausrüstung beim Autor (Frank Schmischke):
    (im Aufbau befindliche Vereinsanlage der
      Puhlheim-Frechener-Eisenbahnfreunde)
    2 Intelliboxen, 50 Weichen, 3 S88-Module von Vissmann mit
    Belegtmeldern von Uhlenbrock, 2 RM-GB-8 (S88-kompatible
    8-fach Rückmelder mit intergrierten Belegtmeldern),
    Loks zur Zeit zwischen 2 und 10 mit Decodern von Lenz und Kühne.

    Celeron mit 366MHz/160MB mit glibc 2.2.2, kernel 2.4.5

    Homepage:   http://srcpd.sourcforge.net

Verwandte Programme:
    siehe http://www.der-moba.de/Digital

Rechtliches: Für die vorliegende Software
    wird keine Haftung übernommen. Aus der
    Tatsache, das es bei den Autoren zu deren 
    Zufriedenheit funktioniert kann niemals 
    geschlußfolgert werden, das es auch bei 
    anderen funktioniert und keinen 
    Schaden anrichtet. Wer dieses Programm
    benutzt, tut es auf eigene Gefahr. Es gab
    schon irreparable Hardwareschäden (dies
    aber wirklich nur für die Advokaten)!
    
Sonst noch was?
    Jede Änderung und jeder Erfahrungsbericht
    ist a) willkommen und b) sollte irgendwie
    auch bei den Autoren ankommen. Hilfreich sind
    dann Angaben zur Version (steht im Welcome des
    laufenden Servers).

Last But Not Least:
    Dank geht an die Truppe von www.der_moba.de.
    
Weitere Informationen: 
    http://www.der-moba.de/Digital
    http://srcpd.sourceforge.net
    
